<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NV:RP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --font-heading: 'Audiowide', sans-serif; --font-body: 'Rajdhani', sans-serif; --color-green-accent: #39FF14; --color-cyan-accent: #00FFFF;}
        body { font-family: var(--font-body); }
        h1, h2, h3, h4 { font-family: var(--font-heading); }
        .text-glow-green { text-shadow: 0 0 5px var(--color-green-accent), 0 0 10px var(--color-green-accent); }
        #sidebar, #main-content { transition: all 0.3s ease-in-out; }
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-open #overlay { opacity: 1; pointer-events: auto; }
        #overlay { transition: opacity 0.3s ease-in-out; }
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: transform 0.2s ease-in-out; }
        .admin-command-btn { @apply bg-gray-700 text-white px-3 py-1 rounded text-sm font-bold hover:bg-gray-600 transition-colors; }
        .status-select.processed { @apply bg-green-500/10 text-green-400 border-green-500/30; }
        .status-select.pending { @apply bg-yellow-500/10 text-yellow-400 border-yellow-500/30; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    
    <aside id="sidebar" class="bg-gray-900 text-white w-64 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 z-50">
        <div class="p-5 text-center">
            <h1 class="text-3xl font-black text-[var(--color-green-accent)]">NV:RP</h1>
            <p class="text-sm text-gray-400">Admin Panel</p>
        </div>
        <nav class="mt-8">
            <a href="#dashboard" class="nav-link flex items-center py-3 px-5 text-lg text-gray-300 hover:bg-gray-800 hover:text-white"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>
            <a href="#lookup" class="nav-link flex items-center py-3 px-5 text-lg text-gray-300 hover:bg-gray-800 hover:text-white"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>Player Lookup</a>
            <a href="#players" class="nav-link flex items-center py-3 px-5 text-lg text-gray-300 hover:bg-gray-800 hover:text-white"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Applications</a>
            <a href="#donations" class="nav-link flex items-center py-3 px-5 text-lg text-gray-300 hover:bg-gray-800 hover:text-white"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0 1V4m0 2v1m0 0v1m-6 6h12M7 16a5 5 0 01-.894-9.902l-1.01-1.01A7 7 0 005 16m14 0a7 7 0 00-4.096-6.413l-1.01 1.01A5 5 0 0117 16"/></svg>Donations</a>
            <a href="#" id="logout-btn" class="flex items-center py-3 px-5 text-lg text-red-400 hover:bg-red-500/20 hover:text-red-300 mt-10"><svg class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>Logout</a>
        </nav>
    </aside>
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden opacity-0 pointer-events-none"></div>
    <div id="main-content" class="md:ml-64">
        <header class="md:hidden sticky top-0 bg-gray-900/80 backdrop-blur-sm p-4 flex justify-between items-center"><h1 class="text-xl font-black text-[var(--color-green-accent)]">NV:RP Admin</h1><button id="menu-btn"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button></header>
        <main class="p-6 md:p-12">
            <section id="dashboard" class="page-content">
                <h2 class="text-4xl font-extrabold text-glow-green mb-8">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-lg"><p class="text-sm text-gray-400">Total Applicants</p><p id="total-players" class="text-4xl font-bold">0</p></div>
                    <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-lg"><p class="text-sm text-gray-400">Applicants Today</p><p id="players-today" class="text-4xl font-bold">0</p></div>
                    <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-lg"><p class="text-sm text-gray-400">Total Donations</p><p id="total-donations" class="text-4xl font-bold">0</p></div>
                    <div class="bg-gray-900/50 border border-gray-700 p-6 rounded-lg"><p class="text-sm text-gray-400">Pending Donations</p><p id="pending-donations" class="text-4xl font-bold text-yellow-400">0</p></div>
                </div>
                <div class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-3xl font-bold text-white">Online Players (<span id="online-count">0</span>)</h3>
                        <button id="refresh-players-btn" class="p-2 bg-gray-700 rounded-md hover:bg-gray-600 disabled:opacity-50"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5m-9 1l4-4m10 10l-4-4"/></svg></button>
                    </div>
                    <div id="online-players-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
            </section>
            <section id="lookup" class="page-content hidden">
                <h2 class="text-4xl font-extrabold text-glow-green mb-8">Player In-Game Lookup</h2>
                <form id="lookup-form" class="flex items-center gap-4 mb-8">
                    <input type="text" id="player-name-input" placeholder="Enter In-Game Name (e.g., FirstName_LastName)" required class="w-full bg-gray-800 border border-gray-600 rounded-md p-3 focus:ring-2 focus:ring-[var(--color-cyan-accent)] focus:outline-none">
                    <button type="submit" class="bg-[var(--color-cyan-accent)] text-black px-6 py-3 rounded-md font-bold hover:bg-[var(--color-cyan-accent)]/80 flex-shrink-0">Search</button>
                </form>
                <div id="lookup-results" class="hidden"></div>
            </section>
            <section id="players" class="page-content hidden">
                <h2 class="text-4xl font-extrabold text-glow-green mb-8">Player Applications</h2>
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-6 overflow-x-auto"><table class="w-full text-left min-w-[800px]"><thead class="bg-gray-800"><tr><th class="p-4 text-sm font-semibold text-green-400 uppercase">Submitted</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Discord & In-Game</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Age</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Answers</th></tr></thead><tbody id="players-tbody"></tbody></table></div>
            </section>
            <section id="donations" class="page-content hidden">
                <h2 class="text-4xl font-extrabold text-glow-green mb-8">Donation History</h2>
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-6 overflow-x-auto"><table class="w-full text-left min-w-[800px]"><thead class="bg-gray-800"><tr><th class="p-4 text-sm font-semibold text-green-400 uppercase">Date</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Discord & In-Game</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Tier & Amount</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Screenshot</th><th class="p-4 text-sm font-semibold text-green-400 uppercase">Status</th></tr></thead><tbody id="donations-tbody"></tbody></table></div>
            </section>
        </main>
    </div>
    <div id="command-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden opacity-0">
        <div class="modal-content bg-gray-900 border border-[var(--color-cyan-accent)] rounded-lg p-8 max-w-md w-full m-4 transform scale-95">
            <h3 id="modal-title" class="text-2xl font-bold text-[var(--color-cyan-accent)] mb-6">Execute Command</h3>
            <form id="modal-form">
                <div id="modal-value-group" class="mb-4 hidden"><label id="modal-value-label" for="modal-value-input" class="block text-sm font-semibold text-gray-300 mb-1">Amount</label><input type="number" id="modal-value-input" class="w-full bg-gray-800 border border-gray-600 rounded-md p-3 focus:ring-2 focus:ring-[var(--color-cyan-accent)] focus:outline-none"></div>
                <div id="modal-reason-group" class="mb-6"><label for="modal-reason-input" class="block text-sm font-semibold text-gray-300 mb-1">Reason (Optional for Kick/Ban)</label><input type="text" id="modal-reason-input" class="w-full bg-gray-800 border border-gray-600 rounded-md p-3 focus:ring-2 focus:ring-[var(--color-cyan-accent)] focus:outline-none"></div>
                <div class="flex justify-end gap-4"><button type="button" id="modal-cancel-btn" class="bg-gray-600 text-white px-5 py-2 rounded-md font-bold hover:bg-gray-500">Cancel</button><button type="submit" id="modal-confirm-btn" class="bg-[var(--color-cyan-accent)] text-black px-5 py-2 rounded-md font-bold hover:bg-[var(--color-cyan-accent)]/80">Confirm</button></div>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const backendUrl = "https://nigeria-vibe-backend.onrender.com";
            const loggedInAdmin = localStorage.getItem('adminUser') || 'Unknown Admin';
            if (localStorage.getItem('isLoggedIn') !== 'true') { window.location.href = 'admin.html'; return; }
            document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('isLoggedIn'); localStorage.removeItem('adminUser'); window.location.href = 'admin.html'; });
            const menuBtn = document.getElementById('menu-btn'), overlay = document.getElementById('overlay'), body = document.body;
            menuBtn.addEventListener('click', () => body.classList.toggle('sidebar-open'));
            overlay.addEventListener('click', () => body.classList.remove('sidebar-open'));
            const navLinks = document.querySelectorAll('.nav-link'), pages = document.querySelectorAll('.page-content');
            function showPage(hash) { const targetId = hash.substring(1) || 'dashboard'; pages.forEach(p => p.classList.add('hidden')); document.getElementById(targetId)?.classList.remove('hidden'); navLinks.forEach(link => link.classList.toggle('bg-gray-800', link.hash === hash)); body.classList.remove('sidebar-open'); }
            navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = link.hash; }); });
            window.addEventListener('hashchange', () => showPage(window.location.hash));
            const fetchDashboardStats = async () => { try { const res = await fetch(`${backendUrl}/api/dashboard-stats`); const stats = await res.json(); document.getElementById('total-players').textContent = stats.totalPlayers; document.getElementById('players-today').textContent = stats.playersToday; document.getElementById('total-donations').textContent = stats.totalDonations; document.getElementById('pending-donations').textContent = stats.pendingDonations; } catch (error) { console.error('Failed to fetch stats:', error); } };
            const fetchPlayers = async () => { const tbody = document.getElementById('players-tbody'); try { const res = await fetch(`${backendUrl}/api/waitlist`); const players = await res.json(); tbody.innerHTML = ''; if (players.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-400">No applications found.</td></tr>'; return; } players.forEach(p => { const row = document.createElement('tr'); row.className = 'border-b border-gray-800'; row.innerHTML = `<td class="p-4 whitespace-nowrap">${new Date(p.date).toLocaleString()}</td><td class="p-4"><p class="font-bold">${p.discordUser}</p><p class="text-sm text-gray-400">${p.inGameName}</p></td><td class="p-4">${p.age}</td><td class="p-4 text-sm text-gray-300"><details><summary class="cursor-pointer hover:text-white">View Answers</summary><div class="mt-2 space-y-2 p-3 bg-gray-800 rounded"><p><strong class="text-gray-400">RP Definition:</strong> ${p.rpDefinition}</p><p><strong class="text-gray-400">Powergaming:</strong> ${p.powergaming}</p><p><strong class="text-gray-400">Backstory:</strong> ${p.backstory}</p></div></details></td>`; tbody.appendChild(row); }); } catch (error) { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-red-400">Failed to load data.</td></tr>'; } };
            const fetchDonations = async () => { const tbody = document.getElementById('donations-tbody'); try { const response = await fetch(`${backendUrl}/api/donations`); const donations = await response.json(); tbody.innerHTML = ''; if (donations.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-400">No donations found.</td></tr>'; return; } donations.forEach(d => { const row = document.createElement('tr'); row.className = 'border-b border-gray-800 hover:bg-gray-800/50'; row.innerHTML = `<td class="p-4 whitespace-nowrap">${new Date(d.date).toLocaleString()}</td><td class="p-4"><p class="font-bold">${d.discordUser}</p><p class="text-sm text-gray-400">${d.inGameName}</p></td><td class="p-4 font-semibold">${d.tier} <span class="text-[var(--color-cyan-accent)] font-bold">${d.price || ''}</span></td><td class="p-4"><a href="${backendUrl}${d.screenshotUrl}" target="_blank" class="text-[var(--color-cyan-accent)] hover:underline">View Image</a></td><td class="p-4"><select class="status-select w-full p-2 rounded-md border text-sm font-semibold bg-gray-700 ${d.status}" data-id="${d._id}"><option value="pending" ${d.status === 'pending' ? 'selected' : ''}>Pending</option><option value="processed" ${d.status === 'processed' ? 'selected' : ''}>Processed</option></select></td>`; tbody.appendChild(row); }); } catch (error) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-red-400">Failed to load data.</td></tr>'; } };
            const onlineCountEl = document.getElementById('online-count'), onlinePlayersList = document.getElementById('online-players-list'), refreshPlayersBtn = document.getElementById('refresh-players-btn');
            const fetchOnlinePlayers = async () => {
                refreshPlayersBtn.disabled = true;
                refreshPlayersBtn.querySelector('svg').classList.add('animate-spin');
                onlinePlayersList.innerHTML = '<p class="text-gray-400 col-span-full">Loading players...</p>';
                try {
                    const response = await fetch(`${backendUrl}/api/admin/online-players`);
                    const players = await response.json();
                    onlineCountEl.textContent = players.length;
                    onlinePlayersList.innerHTML = '';
                    if (players.length === 0) { onlinePlayersList.innerHTML = '<p class="text-gray-400 col-span-full">Server is empty or offline.</p>'; return; }
                    players.forEach(player => {
                        const playerCard = document.createElement('a');
                        playerCard.href = `#lookup`;
                        playerCard.className = 'online-player-card bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-colors block';
                        playerCard.dataset.name = player.name;
                        playerCard.innerHTML = `<p class="font-bold text-lg text-white">${player.name}</p><div class="flex justify-between text-sm text-gray-400 mt-1"><span>ID: ${player.id}</span><span>Ping: ${player.ping}</span></div>`;
                        onlinePlayersList.appendChild(playerCard);
                    });
                } catch (error) { onlinePlayersList.innerHTML = '<p class="text-red-400 col-span-full">Failed to load online players.</p>'; }
                finally {
                    refreshPlayersBtn.disabled = false;
                    refreshPlayersBtn.querySelector('svg').classList.remove('animate-spin');
                }
            };
            refreshPlayersBtn.addEventListener('click', fetchOnlinePlayers);
            onlinePlayersList.addEventListener('click', (e) => {
                const card = e.target.closest('.online-player-card');
                if (card) { e.preventDefault(); playerNameInput.value = card.dataset.name; lookupForm.dispatchEvent(new Event('submit')); window.location.hash = '#lookup'; }
            });
            const lookupForm = document.getElementById('lookup-form'), lookupResultsContainer = document.getElementById('lookup-results'), playerNameInput = document.getElementById('player-name-input'), modal = document.getElementById('command-modal');
            let currentAction = {};
            lookupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const playerName = playerNameInput.value.trim();
                if (!playerName) return;
                lookupResultsContainer.classList.remove('hidden');
                lookupResultsContainer.innerHTML = '<p class="text-center text-lg">Searching...</p>';
                try {
                    const response = await fetch(`${backendUrl}/api/player/${playerName}`);
                    const data = await response.json();
                    if (!response.ok) { throw new Error(data.message || 'An error occurred'); }
                    const s = data.stats;
                    let vehiclesHtml = '<p class="text-gray-400">No vehicles found.</p>';
                    if (data.vehicles && data.vehicles.length > 0) { vehiclesHtml = `<div class="overflow-x-auto mt-2"><table class="w-full text-left"><thead class="bg-gray-800"><tr><th class="p-3 text-sm font-semibold text-green-400 uppercase">Model ID</th><th class="p-3 text-sm font-semibold text-green-400 uppercase">Tickets</th></tr></thead><tbody>${data.vehicles.map(v => `<tr class="border-b border-gray-800"><td class="p-3">${v.modelid}</td><td class="p-3">${v.tickets}</td></tr>`).join('')}</tbody></table></div>`; }
                    let propertyLogsHtml = '<p class="text-gray-400">No property logs found for this player.</p>';
                    if (data.propertyLogs && data.propertyLogs.length > 0) { propertyLogsHtml = `<ul class="list-disc list-inside mt-2 space-y-1 text-gray-300 text-sm h-48 overflow-y-auto">${data.propertyLogs.map(log => `<li>${log.description}</li>`).join('')}</ul>`; }
                    lookupResultsContainer.innerHTML = `<div class="bg-gray-900/50 border border-gray-700 rounded-lg p-6"><div class="flex flex-wrap justify-between items-center gap-4 mb-6"><h3 class="text-2xl font-bold text-white">Records for <span class="text-[var(--color-cyan-accent)]">${playerName}</span></h3><div class="flex flex-wrap gap-2" data-player-name="${playerName}"><button class="admin-command-btn" data-command="givemoney">Give Money</button><button class="admin-command-btn" data-command="dealership">To Dealership</button><button class="admin-command-btn" data-command="kick">Kick</button><button class="admin-command-btn" data-command="ban">Ban</button></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6"><div class="space-y-4"><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Faction</p><p class="text-xl font-bold">${s.factionName} (Rank: ${s.factionrank})</p></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Level</p><p class="text-2xl font-bold">${s.level}</p></div><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Hours Played</p><p class="text-2xl font-bold">${s.hours}</p></div></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Cash</p><p class="text-2xl font-bold text-green-400">$${s.cash.toLocaleString()}</p></div><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Bank</p><p class="text-2xl font-bold text-green-400">$${s.bank.toLocaleString()}</p></div></div><div class="grid grid-cols-2 gap-4"><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Fleeca Bank</p><p class="text-2xl font-bold text-cyan-400">$${s.fleeca_bank.toLocaleString()}</p></div><div class="bg-gray-800 p-4 rounded-lg"><p class="text-sm text-gray-400">Crimes</p><p class="text-2xl font-bold text-red-400">${s.crimes}</p></div></div></div><div class="space-y-6"><div><h4 class="text-xl font-bold text-white">Vehicles</h4>${vehiclesHtml}</div><div><h4 class="text-xl font-bold text-white">Property Logs</h4>${propertyLogsHtml}</div></div></div></div>`;
                } catch (error) { lookupResultsContainer.innerHTML = `<p class="text-center text-lg text-red-400">${error.message}</p>`; }
            });
            const modalTitle = document.getElementById('modal-title'), modalForm = document.getElementById('modal-form'), valueGroup = document.getElementById('modal-value-group'), valueLabel = document.getElementById('modal-value-label'), valueInput = document.getElementById('modal-value-input'), reasonGroup = document.getElementById('modal-reason-group'), reasonInput = document.getElementById('modal-reason-input');
            function openCommandModal(command, playerName) {
                currentAction = { command, playerName };
                modalForm.reset();
                valueGroup.classList.add('hidden');
                reasonGroup.classList.remove('hidden');
                if (command === 'givemoney') { modalTitle.textContent = `Give Money to ${playerName}`; valueLabel.textContent = 'Amount'; valueInput.type = 'number'; valueGroup.classList.remove('hidden'); reasonGroup.classList.add('hidden'); }
                else if (command === 'kick') { modalTitle.textContent = `Kick ${playerName}`; }
                else if (command === 'ban') { modalTitle.textContent = `Ban ${playerName}`; }
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            }
            function closeCommandModal() { modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 200); }
            document.getElementById('modal-cancel-btn').addEventListener('click', closeCommandModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeCommandModal(); });
            lookupResultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('admin-command-btn')) {
                    const command = e.target.dataset.command;
                    const playerName = e.target.closest('[data-player-name]').dataset.playerName;
                    if (command === 'dealership') { if (confirm(`Are you sure you want to send ${playerName} to the dealership?`)) executeCommand({ command, playerName }); }
                    else { openCommandModal(command, playerName); }
                }
            });
            modalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const payload = { ...currentAction, adminUser: loggedInAdmin };
                if (!valueGroup.classList.contains('hidden')) payload.value = valueInput.value;
                if (!reasonGroup.classList.contains('hidden')) payload.reason = reasonInput.value;
                executeCommand(payload);
            });
            async function executeCommand(payload) {
                const confirmBtn = document.getElementById('modal-confirm-btn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Executing...';
                try {
                    const response = await fetch(`${backendUrl}/api/admin/command`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    alert(result.message);
                } catch (error) { alert('An error occurred.'); }
                finally { confirmBtn.disabled = false; confirmBtn.textContent = 'Confirm'; closeCommandModal(); }
            }
            const initialLoad = () => { showPage(window.location.hash || '#dashboard'); fetchDashboardStats(); fetchOnlinePlayers(); fetchPlayers(); fetchDonations(); };
            initialLoad();
        });
    </script>
</body>
</html>