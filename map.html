<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Map - NV:RP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-heading: 'Audiowide', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --color-green-accent: #39FF14;
            --color-cyan-accent: #00FFFF;
        }
        body { font-family: var(--font-body); overflow: hidden; }
        h1, h2, h3 { font-family: var(--font-heading); }
        .text-glow-green { text-shadow: 0 0 5px var(--color-green-accent), 0 0 10px var(--color-green-accent); }
        #map-container { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: grab; background-color: #111827; }
        #map-container.grabbing { cursor: grabbing; }
        #map-image { position: absolute; width: 2048px; height: 2048px; background-image: url('https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/942d6817-886f-440a-a790-43043fcb13ae/db1p8cc-f8729260-60cf-4248-829a-8b705c485256.jpg?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiIvZi85NDJkNjgxNy04ODZmLTQ0MGEtYTc5MC00MzA0M2ZjYjEzYWUvZGIxcDhjYy1mODcyOTI2MC02MGNmLTQyNDgtODI5YS04YjcwNWM0ODUyNTYuanBnIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.k3fCJFdT-Neio0rGT92VJXUDX4QedT5UJBWQYsaFfT4'); background-size: cover; image-rendering: -webkit-optimize-contrast; transform-origin: 0 0; }
        
        #heatmap-canvas, #route-canvas { position: absolute; width: 2048px; height: 2048px; pointer-events: none; }
        #heatmap-canvas { opacity: 0; transition: opacity 0.3s ease-in-out; }
        #heatmap-canvas.visible { opacity: 0.9; }
        #route-canvas { z-index: 9; }

        .player-marker {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            will-change: transform, left, top; z-index: 10; cursor: pointer;
            transition: left 4.5s linear, top 4.5s linear;
        }
        .player-dot { border-radius: 50%; transition: all 0.2s ease-in-out; border: 3px solid white; }
        .player-name { position: absolute; bottom: 100%; margin-bottom: 8px; background-color: rgba(17, 24, 39, 0.8); color: white; padding: 4px 8px; border-radius: 6px; font-size: 14px; font-weight: 600; white-space: nowrap; pointer-events: none; border: 1px solid rgb(255, 0, 0); backdrop-filter: blur(2px); }
        .player-marker.names-hidden .player-name { display: none; }
        .player-name::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: rgba(17, 24, 39, 0.8) transparent transparent transparent; }
        .player-marker:hover { z-index: 11; }
        .player-marker.located .player-dot { animation: pulse-player 2.5s infinite; }
        #search-highlighter { animation: pulse-property 2.5s infinite; }

        @keyframes pulse-player { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes pulse-property { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 25px rgba(0, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0); } }
        
        .property-marker { position: absolute; width: 28px; height: 28px; z-index: 5; cursor: pointer; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)); transition: transform 0.2s ease; }
        .property-marker svg { width: 100%; height: 100%; }
        .property-marker:hover { transform: scale(1.25) !important; z-index: 6; }
        
        #search-highlighter { position: absolute; z-index: 8; width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--color-cyan-accent); pointer-events: none; }

        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* Add these new styles inside your <style> tag */

        .route-hitbox-segment {
            position: absolute;
            height: 10px; /* Make hitbox slightly larger for easier hover */
            background: transparent; /* Invisible */
            transform-origin: 0 50%;
            pointer-events: auto; /* Allow hovering */
            cursor: pointer;
            z-index: 10; /* Ensure it's above the canvas but below player markers */
        }
        /* Optional: for debugging hitboxes, remove in production */
        /* .route-hitbox-segment:hover {
            background: rgba(255,0,0,0.2);
        } */

        #route-tooltip {
            transform: translate(-50%, -120%); /* Position above the cursor */
        }
    </style>
</head>
<body class="bg-gray-950 text-white">
    <div id="map-container">
        <div id="map-image">
            <canvas id="heatmap-canvas" width="2048" height="2048"></canvas>
            <canvas id="route-canvas" width="2048" height="2048"></canvas>
            <div id="houses-layer"></div>
            <div id="businesses-layer"></div>
            <div id="route-hitboxes"></div>
            </div>
    </div>

    <div class="absolute top-4 left-4 bg-gray-900/80 p-4 rounded-lg shadow-lg z-20 max-w-sm">
        <h1 class="text-2xl font-bold text-glow-green mb-2">NV:RP Live Map</h1>
        <p class="text-gray-300">Total Players Tracked: <span id="player-count">0</span></p>
        
        <div class="mt-4">
            <label for="player-search" class="block text-sm font-medium text-gray-300">Search Player</label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" id="player-search" class="block w-full rounded-none rounded-l-md bg-gray-800 border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm px-3 py-2" placeholder="Enter username...">
                <button id="search-btn" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-600 bg-gray-700 px-4 py-2 text-sm font-medium text-gray-200 hover:bg-gray-600"><span>Locate</span></button>
            </div>
        </div>
        
        <div class="mt-4">
            <label for="property-search" class="block text-sm font-medium text-gray-300">Search Property</label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" id="property-search" class="block w-full rounded-none rounded-l-md bg-gray-800 border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 sm:text-sm px-3 py-2" placeholder="ID or Owner Name...">
                <button id="property-search-btn" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-600 bg-gray-700 px-4 py-2 text-sm font-medium text-gray-200 hover:bg-gray-600"><span>Find</span></button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
             <label class="flex items-center space-x-2"><input type="checkbox" id="online-only-toggle" class="form-checkbox h-5 w-5 text-cyan-400 bg-gray-700 border-gray-500 rounded focus:ring-cyan-500" checked><span class="text-gray-300">Online Only</span></label>
             <label class="flex items-center space-x-2"><input type="checkbox" id="toggle-names-btn" class="form-checkbox h-5 w-5 text-cyan-400 bg-gray-700 border-gray-500 rounded focus:ring-cyan-500" checked><span class="text-gray-300">Player Names</span></label>
             <label class="flex items-center space-x-2"><input type="checkbox" id="heatmap-toggle" class="form-checkbox h-5 w-5 text-cyan-400 bg-gray-700 border-gray-500 rounded focus:ring-cyan-500"><span class="text-gray-300">Player Heatmap</span></label>
             <label class="flex items-center space-x-2"><input type="checkbox" id="toggle-houses-btn" class="form-checkbox h-5 w-5 text-cyan-400 bg-gray-700 border-gray-500 rounded focus:ring-cyan-500" checked><span class="text-gray-300">Show Houses</span></label>
             <label class="flex items-center space-x-2"><input type="checkbox" id="toggle-businesses-btn" class="form-checkbox h-5 w-5 text-cyan-400 bg-gray-700 border-gray-500 rounded focus:ring-cyan-500" checked><span class="text-gray-300">Show Businesses</span></label>
        </div>
        <a href="dashboard.html" class="inline-block mt-4 text-cyan-400 hover:text-cyan-300 transition-colors duration-200">‚Üê Back to Dashboard</a>
    </div>

    <div class="absolute bottom-4 right-4 z-20 flex flex-col space-y-2">
        <button id="zoom-in-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full">+</button>
        <button id="zoom-out-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full">-</button>
    </div>

    <div id="coord-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 opacity-0">
        <div class="modal-content bg-gray-900 border-2 border-[var(--color-cyan-accent)] rounded-lg p-6 w-full max-w-sm text-center opacity-0 transform scale-95">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-glow-green"></h3>
            <div id="modal-body">
                </div>
            <button id="show-route-btn" class="hidden mt-4 w-full bg-blue-500 text-white px-6 py-2 rounded-md font-bold hover:bg-blue-600">Show Last 30 MINUTES Route</button>
            <button id="teleport-btn" class="mt-6 w-full bg-green-500 text-white px-6 py-2 rounded-md font-bold hover:bg-green-600/80">Teleport Player</button>
            <button id="close-coord-modal" class="mt-2 w-full bg-[var(--color-cyan-accent)] text-black px-6 py-2 rounded-md font-bold hover:bg-[var(--color-cyan-accent)]/80">Close</button>
        </div>
    </div>

    <div id="route-tooltip" class="hidden absolute bg-black/80 text-white text-sm px-3 py-1 rounded-md pointer-events-none z-50"></div>

    <script src="https://cdn.jsdelivr.net/npm/simpleheat@0.4.0/simpleheat.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const backendUrl = "https://nigeria-vibe-backend.onrender.com";
        const mapContainer = document.getElementById('map-container');
        const mapImage = document.getElementById('map-image');
        const playerCountSpan = document.getElementById('player-count');
        const searchInput = document.getElementById('player-search');
        const searchBtn = document.getElementById('search-btn');
        const propertySearchInput = document.getElementById('property-search');
        const propertySearchBtn = document.getElementById('property-search-btn');
        const coordModal = document.getElementById('coord-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeCoordModalBtn = document.getElementById('close-coord-modal');
        const teleportBtn = document.getElementById('teleport-btn');
        const showRouteBtn = document.getElementById('show-route-btn'); // Ensure this is correctly retrieved
        const heatmapToggle = document.getElementById('heatmap-toggle');
        const onlineOnlyToggle = document.getElementById('online-only-toggle');
        const toggleNamesBtn = document.getElementById('toggle-names-btn');
        const toggleHousesBtn = document = document.getElementById('toggle-houses-btn');
        const toggleBusinessesBtn = document.getElementById('toggle-businesses-btn');
        const heatmapCanvas = document.getElementById('heatmap-canvas');
        const housesLayer = document.getElementById('houses-layer');
        const businessesLayer = document.getElementById('businesses-layer');
        const routeCanvas = document.getElementById('route-canvas');
        const routeCtx = routeCanvas.getContext('2d');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const routeHitboxes = document.getElementById('route-hitboxes');
        const routeTooltip = document.getElementById('route-tooltip');
        
        // --- GLOBAL STATE ---
        let allPlayersData = [], playersData = [], allProperties = { houses: [], businesses: [] };
        const heat = simpleheat(heatmapCanvas);
        const zones = [ ["The Big Ear",-410,1403.3,-3,-137.9,1681.2,200],["Aldea Malvada",-1372.1,2498.5,0,-1277.5,2615.3,200],["Angel Pine",-2324.9,-2584.2,-6.1,-1964.2,-2212.1,200],["Arco del Oeste",-901.1,2221.8,0,-592,2571.9,200],
                ["Avispa Country Club",-2646.4,-355.4,0,-2270,-222.5,200],["Avispa Country Club",-2831.8,-430.2,-6.1,-2646.4,-222.5,200],["Avispa Country Club",-2361.5,-417.1,0,-2270,-355.4,200],["Avispa Country Club",-2667.8,-302.1,-28.8,-2646.4,-262.3,71.1],
                ["Avispa Country Club",-2470,-355.4,0,-2270,-318.4,46.1],["Avispa Country Club",-2550,-355.4,0,-2470,-318.4,39.7],["Back o Beyond",-1166.9,-2641.1,0,-321.7,-1856,200],["Battery Point",-2741,1268.4,-4.5,-2533,1490.4,200],
                ["Bayside",-2741,2175.1,0,-2353.1,2722.7,200],["Bayside Marina",-2353.1,2275.7,0,-2153.1,2475.7,200],["Beacon Hill",-399.6,-1075.5,-1.4,-319,-977.5,198.5],["Blackfield",964.3,1203.2,-89,1197.3,1403.2,110.9],
                ["Blackfield",964.3,1403.2,-89,1197.3,1726.2,110.9],["Blackfield Chapel",1375.6,596.3,-89,1558,823.2,110.9],["Blackfield Chapel",1325.6,596.3,-89,1375.6,795,110.9],["Blackfield Intersection",1197.3,1044.6,-89,1277,1163.3,110.9],
                ["Blackfield Intersection",1166.5,795,-89,1375.6,1044.6,110.9],["Blackfield Intersection",1277,1044.6,-89,1315.3,1087.6,110.9],["Blackfield Intersection",1375.6,823.2,-89,1457.3,919.4,110.9],["Blueberry",104.5,-220.1,2.3,349.6,152.2,200],
                ["Blueberry",19.6,-404.1,3.8,349.6,-220.1,200],["Blueberry Acres",-319.6,-220.1,0,104.5,293.3,200],["Caligula's Palace",2087.3,1543.2,-89,2437.3,1703.2,110.9],["Caligula's Palace",2137.4,1703.2,-89,2437.3,1783.2,110.9],
                ["Calton Heights",-2274.1,744.1,-6.1,-1982.3,1358.9,200],["Chinatown",-2274.1,578.3,-7.6,-2078.6,744.1,200],["City Hall",-2867.8,277.4,-9.1,-2593.4,458.4,200],["Come-A-Lot",2087.3,943.2,-89,2623.1,1203.2,110.9],
                ["Commerce",1323.9,-1842.2,-89,1701.9,-1722.2,110.9],["Commerce",1323.9,-1722.2,-89,1440.9,-1577.5,110.9],["Commerce",1370.8,-1577.5,-89,1463.9,-1384.9,110.9],["Commerce",1463.9,-1577.5,-89,1667.9,-1430.8,110.9],
                ["Commerce",1583.5,-1722.2,-89,1758.9,-1577.5,110.9],["Commerce",1667.9,-1577.5,-89,1812.6,-1430.8,110.9],["Badagry",1046.1,-1804.2,-89,1323.9,-1722.2,110.9],["Badagry",1073.2,-1842.2,-89,1323.9,-1804.2,110.9],
                ["Cranberry Station",-2007.8,56.3,0,-1922,224.7,100],["Creek",2749.9,1937.2,-89,2921.6,2669.7,110.9],["Dillimore",580.7,-674.8,-9.5,861,-404.7,200],["Doherty",-2270,-324.1,-0,-1794.9,-222.5,200],
                ["Doherty",-2173,-222.5,-0,-1794.9,265.2,200],["Downtown",-1982.3,744.1,-6.1,-1871.7,1274.2,200],["Downtown",-1871.7,1176.4,-4.5,-1620.3,1274.2,200],["Downtown",-1700,744.2,-6.1,-1580,1176.5,200],
                ["Downtown",-1580,744.2,-6.1,-1499.8,1025.9,200],["Downtown",-2078.6,578.3,-7.6,-1499.8,744.2,200],["Downtown",-1993.2,265.2,-9.1,-1794.9,578.3,200],["Downtown Los Santos",1463.9,-1430.8,-89,1724.7,-1290.8,110.9],
                ["Downtown Los Santos",1724.7,-1430.8,-89,1812.6,-1250.9,110.9],["Downtown Los Santos",1463.9,-1290.8,-89,1724.7,-1150.8,110.9],["Downtown Los Santos",1370.8,-1384.9,-89,1463.9,-1170.8,110.9],
                ["Downtown Los Santos",1724.7,-1250.9,-89,1812.6,-1150.8,110.9],["Downtown Los Santos",1370.8,-1170.8,-89,1463.9,-1130.8,110.9],["Downtown Los Santos",1378.3,-1130.8,-89,1463.9,-1026.3,110.9],
                ["Downtown Los Santos",1391,-1026.3,-89,1463.9,-926.9,110.9],["Downtown Los Santos",1507.5,-1385.2,110.9,1582.5,-1325.3,335.9],["East Beach",2632.8,-1852.8,-89,2959.3,-1668.1,110.9],
                ["East Beach",2632.8,-1668.1,-89,2747.7,-1393.4,110.9],["East Beach",2747.7,-1668.1,-89,2959.3,-1498.6,110.9],["East Beach",2747.7,-1498.6,-89,2959.3,-1120,110.9],["East Los Santos",2421,-1628.5,-89,2632.8,-1454.3,110.9],
                ["East Los Santos",2222.5,-1628.5,-89,2421,-1494,110.9],["East Los Santos",2266.2,-1494,-89,2381.6,-1372,110.9],["East Los Santos",2381.6,-1494,-89,2421,-1454.3,110.9],["East Los Santos",2281.4,-1372,-89,2381.6,-1135,110.9],
                ["East Los Santos",2381.6,-1454.3,-89,2462.1,-1135,110.9],["East Los Santos",2462.1,-1454.3,-89,2581.7,-1135,110.9],["Easter Basin",-1794.9,249.9,-9.1,-1242.9,578.3,200],["Easter Basin",-1794.9,-50,-0,-1499.8,249.9,200],
                ["Easter Bay Airport",-1499.8,-50,-0,-1242.9,249.9,200],["Easter Bay Airport",-1794.9,-730.1,-3,-1213.9,-50,200],["Easter Bay Airport",-1213.9,-730.1,0,-1132.8,-50,200],["Easter Bay Airport",-1242.9,-50,0,-1213.9,578.3,200],
                ["Easter Bay Airport",-1213.9,-50,-4.5,-947.9,578.3,200],["Easter Bay Airport",-1315.4,-405.3,15.4,-1264.4,-209.5,25.4],["Easter Bay Airport",-1354.3,-287.3,15.4,-1315.4,-209.5,25.4],
                ["Easter Bay Airport",-1490.3,-209.5,15.4,-1264.4,-148.3,25.4],["Easter Bay Chemicals",-1132.8,-768,0,-956.4,-578.1,200],["Easter Bay Chemicals",-1132.8,-787.3,0,-956.4,-768,200],["El Castillo del Diablo",-464.5,2217.6,0,-208.5,2580.3,200],
                ["El Castillo del Diablo",-208.5,2123,-7.6,114,2337.1,200],["El Castillo del Diablo",-208.5,2337.1,0,8.4,2487.1,200],["El Corona",1812.6,-2179.2,-89,1970.6,-1852.8,110.9],["El Corona",1692.6,-2179.2,-89,1812.6,-1842.2,110.9],
                ["El Quebrados",-1645.2,2498.5,0,-1372.1,2777.8,200],["Esplanade East",-1620.3,1176.5,-4.5,-1580,1274.2,200],["Esplanade East",-1580,1025.9,-6.1,-1499.8,1274.2,200],["Esplanade East",-1499.8,578.3,-79.6,-1339.8,1274.2,20.3],
                ["Esplanade North",-2533,1358.9,-4.5,-1996.6,1501.2,200],["Esplanade North",-1996.6,1358.9,-4.5,-1524.2,1592.5,200],["Esplanade North",-1982.3,1274.2,-4.5,-1524.2,1358.9,200],["Fallen Tree",-792.2,-698.5,-5.3,-452.4,-380,200],
                ["Fallow Bridge",434.3,366.5,0,603,555.6,200],["Fern Ridge",508.1,-139.2,0,1306.6,119.5,200],["Financial",-1871.7,744.1,-6.1,-1701.3,1176.4,300],["Fisher's Lagoon",1916.9,-233.3,-100,2131.7,13.8,200],
                ["Flint Intersection",-187.7,-1596.7,-89,17,-1276.6,110.9],["Flint Range",-594.1,-1648.5,0,-187.7,-1276.6,200],["Fort Carson",-376.2,826.3,-3,123.7,1220.4,200],["Foster Valley",-2270,-430.2,-0,-2178.6,-324.1,200],
                ["Foster Valley",-2178.6,-599.8,-0,-1794.9,-324.1,200],["Foster Valley",-2178.6,-1115.5,0,-1794.9,-599.8,200],["Foster Valley",-2178.6,-1250.9,0,-1794.9,-1115.5,200],["Frederick Bridge",2759.2,296.5,0,2774.2,594.7,200],
                ["Gant Bridge",-2741.4,1659.6,-6.1,-2616.4,2175.1,200],["Gant Bridge",-2741,1490.4,-6.1,-2616.4,1659.6,200],["Ganton",2222.5,-1852.8,-89,2632.8,-1722.3,110.9],["Ganton",2222.5,-1722.3,-89,2632.8,-1628.5,110.9],
                ["Garcia",-2411.2,-222.5,-0,-2173,265.2,200],["Garcia",-2395.1,-222.5,-5.3,-2354,-204.7,200],["Garver Bridge",-1339.8,828.1,-89,-1213.9,1057,110.9],["Garver Bridge",-1213.9,950,-89,-1087.9,1178.9,110.9],
                ["Garver Bridge",-1499.8,696.4,-179.6,-1339.8,925.3,20.3],["Glen Park",1812.6,-1449.6,-89,1996.9,-1350.7,110.9],["Glen Park",1812.6,-1100.8,-89,1994.3,-973.3,110.9],["Glen Park",1812.6,-1350.7,-89,2056.8,-1100.8,110.9],
                ["Green Palms",176.5,1305.4,-3,338.6,1520.7,200],["Greenglass College",964.3,1044.6,-89,1197.3,1203.2,110.9],["Greenglass College",964.3,930.8,-89,1166.5,1044.6,110.9],["Hampton Barns",603,264.3,0,761.9,366.5,200],
                ["Hankypanky Point",2576.9,62.1,0,2759.2,385.5,200],["Harry Gold Parkway",1777.3,863.2,-89,1817.3,2342.8,110.9],["Hashbury",-2593.4,-222.5,-0,-2411.2,54.7,200],["Hilltop Farm",967.3,-450.3,-3,1176.7,-217.9,200],
                ["Hunter Quarry",337.2,710.8,-115.2,860.5,1031.7,203.7],["Idlewood",1812.6,-1852.8,-89,1971.6,-1742.3,110.9],["Idlewood",1812.6,-1742.3,-89,1951.6,-1602.3,110.9],["Idlewood",1951.6,-1742.3,-89,2124.6,-1602.3,110.9],
                ["Idlewood",1812.6,-1602.3,-89,2124.6,-1449.6,110.9],["Idlewood",2124.6,-1742.3,-89,2222.5,-1494,110.9],["Idlewood",1971.6,-1852.8,-89,2222.5,-1742.3,110.9],["Jefferson",1996.9,-1449.6,-89,2056.8,-1350.7,110.9],
                ["Jefferson",2124.6,-1494,-89,2266.2,-1449.6,110.9],["Jefferson",2056.8,-1372,-89,2281.4,-1210.7,110.9],["Jefferson",2056.8,-1210.7,-89,2185.3,-1126.3,110.9],["Jefferson",2185.3,-1210.7,-89,2281.4,-1154.5,110.9],
                ["Jefferson",2056.8,-1449.6,-89,2266.2,-1372,110.9],["Julius Thruway East",2623.1,943.2,-89,2749.9,1055.9,110.9],["Julius Thruway East",2685.1,1055.9,-89,2749.9,2626.5,110.9],["Julius Thruway East",2536.4,2442.5,-89,2685.1,2542.5,110.9],
                ["Julius Thruway East",2625.1,2202.7,-89,2685.1,2442.5,110.9],["Julius Thruway North",2498.2,2542.5,-89,2685.1,2626.5,110.9],["Julius Thruway North",2237.4,2542.5,-89,2498.2,2663.1,110.9],["Julius Thruway North",2121.4,2508.2,-89,2237.4,2663.1,110.9],
                ["Julius Thruway North",1938.8,2508.2,-89,2121.4,2624.2,110.9],["Julius Thruway North",1534.5,2433.2,-89,1848.4,2583.2,110.9],["Julius Thruway North",1848.4,2478.4,-89,1938.8,2553.4,110.9],["Julius Thruway North",1704.5,2342.8,-89,1848.4,2433.2,110.9],
                ["Julius Thruway North",1377.3,2433.2,-89,1534.5,2507.2,110.9],["Julius Thruway South",1457.3,823.2,-89,2377.3,863.2,110.9],["Julius Thruway South",2377.3,788.8,-89,2537.3,897.9,110.9],["Julius Thruway West",1197.3,1163.3,-89,1236.6,2243.2,110.9],
                ["Julius Thruway West",1236.6,2142.8,-89,1297.4,2243.2,110.9],["Juniper Hill",-2533,578.3,-7.6,-2274.1,968.3,200],["Juniper Hollow",-2533,968.3,-6.1,-2274.1,1358.9,200],["K.A.C.C. Military Fuels",2498.2,2626.5,-89,2749.9,2861.5,110.9],
                ["Kincaid Bridge",-1339.8,599.2,-89,-1213.9,828.1,110.9],["Kincaid Bridge",-1213.9,721.1,-89,-1087.9,950,110.9],["Kincaid Bridge",-1087.9,855.3,-89,-961.9,986.2,110.9],["King's",-2329.3,458.4,-7.6,-1993.2,578.3,200],
                ["King's",-2411.2,265.2,-9.1,-1993.2,373.5,200],["King's",-2253.5,373.5,-9.1,-1993.2,458.4,200],["LVA Freight Depot",1457.3,863.2,-89,1777.4,1143.2,110.9],["LVA Freight Depot",1375.6,919.4,-89,1457.3,1203.2,110.9],
                ["LVA Freight Depot",1277,1087.6,-89,1375.6,1203.2,110.9],["LVA Freight Depot",1315.3,1044.6,-89,1375.6,1087.6,110.9],["LVA Freight Depot",1236.6,1163.4,-89,1277,1203.2,110.9],["Las Barrancas",-926.1,1398.7,-3,-719.2,1634.6,200],
                ["Las Brujas",-365.1,2123,-3,-208.5,2217.6,200],["Las Colinas",1994.3,-1100.8,-89,2056.8,-920.8,110.9],["Las Colinas",2056.8,-1126.3,-89,2126.8,-920.8,110.9],["Las Colinas",2185.3,-1154.5,-89,2281.4,-934.4,110.9],
                ["Las Colinas",2126.8,-1126.3,-89,2185.3,-934.4,110.9],["Las Colinas",2747.7,-1120,-89,2959.3,-945,110.9],["Las Colinas",2632.7,-1135,-89,2747.7,-945,110.9],["Las Colinas",2281.4,-1135,-89,2632.7,-945,110.9],
                ["Las Payasadas",-354.3,2580.3,2,-133.6,2816.8,200],["Las Venturas Airport",1236.6,1203.2,-89,1457.3,1883.1,110.9],["Las Venturas Airport",1457.3,1203.2,-89,1777.3,1883.1,110.9],["Las Venturas Airport",1457.3,1143.2,-89,1777.4,1203.2,110.9],
                ["Las Venturas Airport",1515.8,1586.4,-12.5,1729.9,1714.5,87.5],["Last Dime Motel",1823,596.3,-89,1997.2,823.2,110.9],["Leafy Hollow",-1166.9,-1856,0,-815.6,-1602,200],["Liberty City",-1000,400,1300,-700,600,1400],
                ["Lil' Probe Inn",-90.2,1286.8,-3,153.8,1554.1,200],["Linden Side",2749.9,943.2,-89,2923.3,1198.9,110.9],["Linden Station",2749.9,1198.9,-89,2923.3,1548.9,110.9],["Linden Station",2811.2,1229.5,-39.5,2861.2,1407.5,60.4],
                ["Little Mexico",1701.9,-1842.2,-89,1812.6,-1722.2,110.9],["Little Mexico",1758.9,-1722.2,-89,1812.6,-1577.5,110.9],["Los Flores",2581.7,-1454.3,-89,2632.8,-1393.4,110.9],["Los Flores",2581.7,-1393.4,-89,2747.7,-1135,110.9],
                ["Los Santos International",1249.6,-2394.3,-89,1852,-2179.2,110.9],["Los Santos International",1852,-2394.3,-89,2089,-2179.2,110.9],["Los Santos International",1382.7,-2730.8,-89,2201.8,-2394.3,110.9],["Los Santos International",1974.6,-2394.3,-39,2089,-2256.5,60.9],
                ["Los Santos International",1400.9,-2669.2,-39,2189.8,-2597.2,60.9],["Los Santos International",2051.6,-2597.2,-39,2152.4,-2394.3,60.9],["Ikoyi",647.7,-1804.2,-89,851.4,-1577.5,110.9],["Ikoyi",647.7,-1577.5,-89,807.9,-1416.2,110.9],
                ["Ikoyi",807.9,-1577.5,-89,926.9,-1416.2,110.9],["Computer Village",787.4,-1416.2,-89,1072.6,-1310.2,110.9],["Computer Village",952.6,-1310.2,-89,1072.6,-1130.8,110.9],["Computer Village",1072.6,-1416.2,-89,1370.8,-1130.8,110.9],
                ["Computer Village",926.9,-1577.5,-89,1370.8,-1416.2,110.9],["Ajah Station",787.4,-1410.9,-34.1,866,-1310.2,65.8],["Martin Bridge",-222.1,293.3,0,-122.1,476.4,200],["Missionary Hill",-2994.4,-811.2,0,-2178.6,-430.2,200],
                ["Montgomery",1119.5,119.5,-3,1451.4,493.3,200],["Montgomery",1451.4,347.4,-6.1,1582.4,420.8,200],["Montgomery Intersection",1546.6,208.1,0,1745.8,347.4,200],["Montgomery Intersection",1582.4,347.4,0,1664.6,401.7,200],
                ["Mulholland",1414,-768,-89,1667.6,-452.4,110.9],["Mulholland",1281.1,-452.4,-89,1641.1,-290.9,110.9],["Mulholland",1269.1,-768,-89,1414,-452.4,110.9],["Mulholland",1357,-926.9,-89,1463.9,-768,110.9],
                ["Mulholland",1318.1,-910.1,-89,1357,-768,110.9],["Mulholland",1169.1,-910.1,-89,1318.1,-768,110.9],["Mulholland",768.6,-954.6,-89,952.6,-860.6,110.9],["Mulholland",687.8,-860.6,-89,911.8,-768,110.9],
                ["Mulholland",737.5,-768,-89,1142.2,-674.8,110.9],["Mulholland",1096.4,-910.1,-89,1169.1,-768,110.9],["Mulholland",952.6,-937.1,-89,1096.4,-860.6,110.9],["Mulholland",911.8,-860.6,-89,1096.4,-768,110.9],
                ["Mulholland",861,-674.8,-89,1156.5,-600.8,110.9],["Mulholland Intersection",1463.9,-1150.8,-89,1812.6,-768,110.9],["North Rock",2285.3,-768,0,2770.5,-269.7,200],["Ocean Docks",2373.7,-2697,-89,2809.2,-2330.4,110.9],
                ["Ocean Docks",2201.8,-2418.3,-89,2324,-2095,110.9],["Ocean Docks",2324,-2302.3,-89,2703.5,-2145.1,110.9],["Ocean Docks",2089,-2394.3,-89,2201.8,-2235.8,110.9],["Ocean Docks",2201.8,-2730.8,-89,2324,-2418.3,110.9],
                ["Ocean Docks",2703.5,-2302.3,-89,2959.3,-2126.9,110.9],["Ocean Docks",2324,-2145.1,-89,2703.5,-2059.2,110.9],["Ocean Flats",-2994.4,277.4,-9.1,-2867.8,458.4,200],["Ocean Flats",-2994.4,-222.5,-0,-2593.4,277.4,200],
                ["Ocean Flats",-2994.4,-430.2,-0,-2831.8,-222.5,200],["Octane Springs",338.6,1228.5,0,664.3,1655,200],["Old Venturas Strip",2162.3,2012.1,-89,2685.1,2202.7,110.9],["Palisades",-2994.4,458.4,-6.1,-2741,1339.6,200],
                ["Palomino Creek",2160.2,-149,0,2576.9,228.3,200],["Paradiso",-2741,793.4,-6.1,-2533,1268.4,200],["Pershing Square",1440.9,-1722.2,-89,1583.5,-1577.5,110.9],["Pilgrim",2437.3,1383.2,-89,2624.4,1783.2,110.9],
                ["Pilgrim",2624.4,1383.2,-89,2685.1,1783.2,110.9],["Pilson Intersection",1098.3,2243.2,-89,1377.3,2507.2,110.9],["Pirates in Men's Pants",1817.3,1469.2,-89,2027.4,1703.2,110.9],["Playa del Seville",2703.5,-2126.9,-89,2959.3,-1852.8,110.9],
                ["Prickle Pine",1534.5,2583.2,-89,1848.4,2863.2,110.9],["Prickle Pine",1117.4,2507.2,-89,1534.5,2723.2,110.9],["Prickle Pine",1848.4,2553.4,-89,1938.8,2863.2,110.9],["Prickle Pine",1938.8,2624.2,-89,2121.4,2861.5,110.9],
                ["Queens",-2533,458.4,0,-2329.3,578.3,200],["Queens",-2593.4,54.7,0,-2411.2,458.4,200],["Queens",-2411.2,373.5,0,-2253.5,458.4,200],["Randolph Industrial Estate",1558,596.3,-89,1823,823.2,110.9],
                ["Redsands East",1817.3,2011.8,-89,2106.7,2202.7,110.9],["Redsands East",1817.3,2202.7,-89,2011.9,2342.8,110.9],["Redsands East",1848.4,2342.8,-89,2011.9,2478.4,110.9],["Redsands West",1236.6,1883.1,-89,1777.3,2142.8,110.9],
                ["Redsands West",1297.4,2142.8,-89,1777.3,2243.2,110.9],["Redsands West",1377.3,2243.2,-89,1704.5,2433.2,110.9],["Redsands West",1704.5,2243.2,-89,1777.3,2342.8,110.9],["Regular Tom",-405.7,1712.8,-3,-276.7,1892.7,200],
                ["Richman",647.5,-1118.2,-89,787.4,-954.6,110.9],["Richman",647.5,-954.6,-89,768.6,-860.6,110.9],["Richman",225.1,-1369.6,-89,334.5,-1292,110.9],["Richman",225.1,-1292,-89,466.2,-1235,110.9],
                ["Richman",72.6,-1404.9,-89,225.1,-1235,110.9],["Richman",72.6,-1235,-89,321.3,-1008.1,110.9],["Richman",321.3,-1235,-89,647.5,-1044,110.9],["Richman",321.3,-1044,-89,647.5,-860.6,110.9],
                ["Richman",321.3,-860.6,-89,687.8,-768,110.9],["Richman",321.3,-768,-89,700.7,-674.8,110.9],["Robada Intersection",-1119,1178.9,-89,-862,1351.4,110.9],["Roca Escalante",2237.4,2202.7,-89,2536.4,2542.5,110.9],
                ["Roca Escalante",2536.4,2202.7,-89,2625.1,2442.5,110.9],["Rockshore East",2537.3,676.5,-89,2902.3,943.2,110.9],["Rockshore West",1997.2,596.3,-89,2377.3,823.2,110.9],["Rockshore West",2377.3,596.3,-89,2537.3,788.8,110.9],
                ["Ikeja",72.6,-1684.6,-89,225.1,-1544.1,110.9],["Ikeja",72.6,-1544.1,-89,225.1,-1404.9,110.9],["Ikeja",225.1,-1684.6,-89,312.8,-1501.9,110.9],["Ikeja",225.1,-1501.9,-89,334.5,-1369.6,110.9],
                ["Ikeja",334.5,-1501.9,-89,422.6,-1406,110.9],["Ikeja",312.8,-1684.6,-89,422.6,-1501.9,110.9],["Ikeja",422.6,-1684.6,-89,558,-1570.2,110.9],["Ikeja",558,-1684.6,-89,647.5,-1384.9,110.9],
                ["Ikeja",466.2,-1570.2,-89,558,-1385,110.9],["Ikeja",422.6,-1570.2,-89,466.2,-1406,110.9],["Ikeja",466.2,-1385,-89,647.5,-1235,110.9],["Ikeja",334.5,-1406,-89,466.2,-1292,110.9],
                ["Royal Casino",2087.3,1383.2,-89,2437.3,1543.2,110.9],["San Andreas Sound",2450.3,385.5,-100,2759.2,562.3,200],["Santa Flora",-2741,458.4,-7.6,-2533,793.4,200],["Santa Maria Beach",342.6,-2173.2,-89,647.7,-1684.6,110.9],
                ["Santa Maria Beach",72.6,-2173.2,-89,342.6,-1684.6,110.9],["Shady Cabin",-1632.8,-2263.4,-3,-1601.3,-2231.7,200],["Shady Creeks",-1820.6,-2643.6,-8,-1226.7,-1771.6,200],["Shady Creeks",-2030.1,-2174.8,-6.1,-1820.6,-1771.6,200],
                ["Sobell Rail Yards",2749.9,1548.9,-89,2923.3,1937.2,110.9],["Spinybed",2121.4,2663.1,-89,2498.2,2861.5,110.9],["Starfish Casino",2437.3,1783.2,-89,2685.1,2012.1,110.9],["Starfish Casino",2437.3,1858.1,-39,2495,1970.8,60.9],
                ["Starfish Casino",2162.3,1883.2,-89,2437.3,2012.1,110.9],["Temple",1252.3,-1130.8,-89,1378.3,-1026.3,110.9],["Temple",1252.3,-1026.3,-89,1391,-926.9,110.9],["Temple",1252.3,-926.9,-89,1357,-910.1,110.9],
                ["Temple",952.6,-1130.8,-89,1096.4,-937.1,110.9],["Temple",1096.4,-1130.8,-89,1252.3,-1026.3,110.9],["Temple",1096.4,-1026.3,-89,1252.3,-910.1,110.9],["The Camel's Toe",2087.3,1203.2,-89,2640.4,1383.2,110.9],
                ["The Clown's Pocket",2162.3,1783.2,-89,2437.3,1883.2,110.9],["The Emerald Isle",2011.9,2202.7,-89,2237.4,2508.2,110.9],["The Farm",-1209.6,-1317.1,114.9,-908.1,-787.3,251.9],["The Four Dragons Casino",1817.3,863.2,-89,2027.3,1083.2,110.9],
                ["The High Roller",1817.3,1283.2,-89,2027.3,1469.2,110.9],["The Mako Span",1664.6,401.7,0,1785.1,567.2,200],["The Panopticon",-947.9,-304.3,-1.1,-319.6,327,200],["The Pink Swan",1817.3,1083.2,-89,2027.3,1283.2,110.9],
                ["The Sherman Dam",-968.7,1929.4,-3,-481.1,2155.2,200],["The Strip",2027.4,863.2,-89,2087.3,1703.2,110.9],["The Strip",2106.7,1863.2,-89,2162.3,2202.7,110.9],["The Strip",2027.4,1783.2,-89,2162.3,1863.2,110.9],
                ["The Strip",2027.4,1703.2,-89,2137.4,1783.2,110.9],["The Visage",1817.3,1863.2,-89,2106.7,2011.8,110.9],["The Visage",1817.3,1703.2,-89,2027.4,1863.2,110.9],["Unity Station",1692.6,-1971.8,-20.4,1812.6,-1932.8,79.5],
                ["Valle Ocultado",-936.6,2611.4,2,-715.9,2847.9,200],["Oshodi",930.2,-2488.4,-89,1249.6,-2006.7,110.9],["Oshodi",1073.2,-2006.7,-89,1249.6,-1842.2,110.9],["Oshodi",1249.6,-2179.2,-89,1692.6,-1842.2,110.9],
                ["Verdant Meadows",37,2337.1,-3,435.9,2677.9,200],["Verona Beach",647.7,-2173.2,-89,930.2,-1804.2,110.9],["Verona Beach",930.2,-2006.7,-89,1073.2,-1804.2,110.9],["Verona Beach",851.4,-1804.2,-89,1046.1,-1577.5,110.9],
                ["Verona Beach",1161.5,-1722.2,-89,1323.9,-1577.5,110.9],["Verona Beach",1046.1,-1722.2,-89,1161.5,-1577.5,110.9],["Vinewood",787.4,-1310.2,-89,952.6,-1130.8,110.9],["Vinewood",787.4,-1130.8,-89,952.6,-954.6,110.9],
                ["Vinewood",647.5,-1227.2,-89,787.4,-1118.2,110.9],["Vinewood",647.7,-1416.2,-89,787.4,-1227.2,110.9],["Whitewood Estates",883.3,1726.2,-89,1098.3,2507.2,110.9],["Whitewood Estates",1098.3,1726.2,-89,1197.3,2243.2,110.9],
                ["Willowfield",1970.6,-2179.2,-89,2089,-1852.8,110.9],["Willowfield",2089,-2235.8,-89,2201.8,-1989.9,110.9],["Willowfield",2089,-1989.9,-89,2324,-1852.8,110.9],["Willowfield",2201.8,-2095,-89,2324,-1989.9,110.9],
                ["Willowfield",2541.7,-1941.4,-89,2703.5,-1852.8,110.9],["Willowfield",2324,-2059.2,-89,2541.7,-1852.8,110.9],["Willowfield",2541.7,-2059.2,-89,2703.5,-1941.4,110.9],["Yellow Bell Station",1377.4,2600.4,-21.9,1492.4,2687.3,78],
                ["Ikoyi",44.6,-2892.9,-242.9,2997,-768,900],["Las Venturas",869.4,596.3,-242.9,2997,2993.8,900],["Bone County",-480.5,596.3,-242.9,869.4,2993.8,900],["Tierra Robada",-2997.4,1659.6,-242.9,-480.5,2993.8,900],
                ["Tierra Robada",-1213.9,596.3,-242.9,-480.5,1659.6,900],["San Fierro",-2997.4,-1115.5,-242.9,-1213.9,1659.6,900],["Red County",-1213.9,-768,-242.9,2997,596.3,900],["Flint County",-1213.9,-2892.9,-242.9,44.6,-768,900],
                ["Whetstone",-2997.4,-2892.9,-242.9,-1213.9,-1115.5,900]
             ];
        const factionColors = { 1: '#3B82F6', 2: '#EF4444', 4: '#F59E0B', 5: '#A855F7', 16: '#10B981', default: '#9CA3AF' };
        const icons = {
            house: `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 48 48">
<path fill="#E8EAF6" d="M42 39L6 39 6 23 24 6 42 23z"></path><path fill="#C5CAE9" d="M39 21L34 16 34 9 39 9zM6 39H42V44H6z"></path><path fill="#B71C1C" d="M24 4.3L4 22.9 6 25.1 24 8.4 42 25.1 44 22.9z"></path><path fill="#D84315" d="M18 28H30V44H18z"></path><path fill="#01579B" d="M21 17H27V23H21z"></path><path fill="#FF8A65" d="M27.5,35.5c-0.3,0-0.5,0.2-0.5,0.5v2c0,0.3,0.2,0.5,0.5,0.5S28,38.3,28,38v-2C28,35.7,27.8,35.5,27.5,35.5z"></path>
</svg>`,
            biz_0: `<img width="48" height="48" src="https://img.icons8.com/color/48/shop.png" alt="shop"/>`,
            biz_1: `<img width="64" height="64" src="https://img.icons8.com/external-flaticons-flat-flat-icons/64/external-ammunition-battle-royale-flaticons-flat-flat-icons.png" alt="external-ammunition-battle-royale-flaticons-flat-flat-icons"/>`,
            biz_2: `<img width="96" height="96" src="https://img.icons8.com/color/96/try-on.png" alt="try-on"/>`
        };

        // --- DATA FETCHING & INITIALIZATION ---
        async function initialDataLoad() {
            try {
                const [playersRes, propertiesRes] = await Promise.all([
                    fetch(`${backendUrl}/api/player-locations`),
                    fetch(`${backendUrl}/api/properties`)
                ]);
                if (!playersRes.ok || !propertiesRes.ok) throw new Error('API Error');
                allPlayersData = await playersRes.json();
                allProperties = await propertiesRes.json();
                updatePlayerLocations();
                drawProperties();
            } catch (error) { console.error('Failed to fetch initial map data:', error); }
        }

        async function periodicPlayerUpdate() {
            try {
                const response = await fetch(`${backendUrl}/api/player-locations`);
                if (!response.ok) return;
                allPlayersData = await response.json();
                updatePlayerLocations();
            } catch (error) { console.error('Failed to fetch player updates:', error); }
        }
        
        // --- DRAWING AND UPDATING LOGIC ---
        function updatePlayerLocations() {
            playersData = onlineOnlyToggle.checked ? allPlayersData.filter(p => p.is_online) : allPlayersData;
            playerCountSpan.textContent = playersData.length;
            const existingMarkers = new Set(Array.from(mapImage.querySelectorAll('.player-marker')).map(m => m.id));
            const incomingUsernames = new Set(playersData.map(p => `player-${p.username}`));

            playersData.forEach(player => {
                if (typeof player.pos_x !== 'number' || typeof player.pos_y !== 'number') return;
                const { left, top } = convertCoordinates(player.pos_x, player.pos_y);
                let marker = document.getElementById(`player-${player.username}`);
                
                if (!marker) { // Create new marker
                    marker = document.createElement('div');
                    marker.className = 'player-marker';
                    marker.id = `player-${player.username}`;
                    marker.innerHTML = `<div class="player-name"></div><div class="player-dot"></div>`;
                    mapImage.appendChild(marker);
                    marker.style.transition = 'none';
                    marker.style.left = `${left}px`;
                    marker.style.top = `${top}px`;
                    marker.offsetHeight; 
                    marker.style.transition = 'left 4.5s linear, top 4.5s linear';
                } else {
                    const oldLeft = parseFloat(marker.style.left);
                    const oldTop = parseFloat(marker.style.top);
                    const distance = Math.sqrt(Math.pow(left - oldLeft, 2) + Math.pow(top - oldTop, 2));

                    if (distance > 300) { 
                        marker.style.transition = 'none';
                    }
                    marker.style.left = `${left}px`;
                    marker.style.top = `${top}px`;
                    if (distance > 300) {
                        marker.offsetHeight;
                        marker.style.transition = 'left 4.5s linear, top 4.5s linear';
                    }
                }
                marker.querySelector('.player-name').textContent = player.username;
                marker.querySelector('.player-dot').style.cssText = `background-color: ${getFactionColor(player.faction)}; border: 3px solid ${player.is_online ? 'white' : 'red'}; width: 16px; height: 16px;`;
                marker.querySelector('.player-dot').dataset.username = player.username;
                marker.querySelector('.player-dot').dataset.posX = player.pos_x.toFixed(2);
                marker.querySelector('.player-dot').dataset.posY = player.pos_y.toFixed(2);
                marker.classList.toggle('names-hidden', !toggleNamesBtn.checked);
            });

            existingMarkers.forEach(markerId => {
                if (!incomingUsernames.has(markerId)) document.getElementById(markerId)?.remove();
            });
            updateDotStyles();
            drawHeatmap();
        }

        function drawProperties() {
            housesLayer.style.display = toggleHousesBtn.checked ? 'block' : 'none';
            businessesLayer.style.display = toggleBusinessesBtn.checked ? 'block' : 'none';
            if (toggleHousesBtn.checked) drawLayer(housesLayer, allProperties.houses, 'house');
            if (toggleBusinessesBtn.checked) drawLayer(businessesLayer, allProperties.businesses, 'business');
            updateDotStyles();
        }

        function drawLayer(layer, data, type) {
            layer.innerHTML = '';
            data.forEach(item => {
                const { left, top } = convertCoordinates(item.pos_x, item.pos_y);
                const marker = document.createElement('div');
                marker.className = 'property-marker';
                marker.style.left = `${left - 14}px`;
                marker.style.top = `${top - 14}px`;
                let iconHtml = '', color = '';
                if (type === 'house') {
                    iconHtml = icons.house;
                    color = item.is_owned ? '#EF4444' : '#22C55E';
                    marker.onclick = () => showPropertyModal(item, 'House');
                } else {
                    iconHtml = icons[`biz_${item.type}`] || icons.biz_0;
                    color = item.is_owned ? '#A855F7' : '#3B82F6';
                    marker.onclick = () => showPropertyModal(item, 'Business');
                }
                marker.innerHTML = iconHtml;
                marker.style.color = color;
                layer.appendChild(marker);
            });
        }
        
        function clearRoute() { 
            routeCtx.clearRect(0, 0, routeCanvas.width, routeCanvas.height); 
        }

        async function fetchAndDrawRoute(username) {
            clearRoute(); // Clear previous route before drawing new one
            if (!username) return;
            try {
                const response = await fetch(`${backendUrl}/api/player-route/${username}`);
                const routeData = await response.json();
                if (routeData.length < 2) { 
                    alert(`No recent route data found for ${username} in the last hour.`); 
                    return; 
                }
                
                routeCtx.beginPath();
                routeCtx.strokeStyle = "rgba(0, 255, 255, 0.7)";
                routeCtx.lineWidth = 5 * (1/scale);
                routeCtx.lineCap = "round";
                routeCtx.lineJoin = "round";
                
                const firstPoint = convertCoordinates(routeData[0].pos_x, routeData[0].pos_y);
                routeCtx.moveTo(firstPoint.left, firstPoint.top);
                
                for (let i = 0; i < routeData.length - 1; i++) {
                    const p1 = convertCoordinates(routeData[i].pos_x, routeData[i].pos_y);
                    const p2 = convertCoordinates(routeData[i+1].pos_x, routeData[i+1].pos_y);
                    
                    routeCtx.lineTo(p2.left, p2.top);

                    const dx = p2.left - p1.left;
                    const dy = p2.top - p1.top;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);

                    const hitbox = document.createElement('div');
                    hitbox.className = 'route-hitbox-segment';
                    hitbox.style.left = `${p1.left}px`;
                    hitbox.style.top = `${p1.top}px`;
                    hitbox.style.width = `${length}px`;
                    hitbox.style.transform = `rotate(${angle}rad)`;
                    hitbox.style.marginTop = '-5px'; // Center hitbox on the line
                    hitbox.dataset.timestamp = routeData[i+1].timestamp;
                    routeHitboxes.appendChild(hitbox);
                }
                routeCtx.stroke();
            } catch (error) { 
                console.error("Failed to fetch or draw route:", error); 
                alert("Failed to fetch player route. Check console for details.");
            }
        }

        function drawHeatmap() { heatmapCanvas.classList.toggle('visible', heatmapToggle.checked); if (!heatmapToggle.checked) return; const locations = playersData.map(p => { const { left, top } = convertCoordinates(p.pos_x, p.pos_y); return [left, top, 1]; }); heat.data(locations).max(10).radius(40, 25).draw(); }
        function updateDotStyles() { const newScale = 1 / scale; const clampedScale = Math.max(0.75, Math.min(1.5, newScale)); document.querySelectorAll('.player-marker, .property-marker').forEach(m => m.style.transform = `scale(${clampedScale})`); }

        function showCoordModal(username, posX, posY) {
            modalTitle.textContent = username;
            modalBody.innerHTML = `<p class="text-lg text-white font-mono bg-gray-800 p-4 rounded-md">X: ${posX}, Y: ${posY}</p>
                                 <p class="text-lg text-white font-mono bg-gray-800 p-4 rounded-md mt-2">Zone: ${getZoneName(parseFloat(posX), parseFloat(posY))}</p>`;
            teleportBtn.classList.remove('hidden');
            showRouteBtn.classList.remove('hidden');
            clearRoute();
            
            // Set the onclick handler directly here
            showRouteBtn.onclick = () => {
                fetchAndDrawRoute(username);
                clearRoute();
                
                // After drawing, you might want to adjust the map to center on the route
                // For now, we'll just keep the modal open.
            };

            coordModal.classList.remove('hidden');
            setTimeout(() => { coordModal.classList.remove('opacity-0'); coordModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95'); }, 10);
        }
        
        function showPropertyModal(item, type) {
            modalTitle.textContent = item.name || `${type} #${item.id}`;
            modalBody.innerHTML = `<div class="text-gray-200 text-left"><p><strong>Status:</strong> <span style="color:${item.is_owned ? '#EF4444' : 'var(--color-green-accent)'}">${item.is_owned ? 'Owned' : 'For Sale'}</span></p>
                                   <p><strong>Owner:</strong> ${item.owner || 'N/A'}</p>
                                   <p><strong>Price:</strong> $${item.price.toLocaleString()}</p>
                                   ${type === 'Business' ? `<p><strong>Type:</strong> ${ {0:'24/7 Store', 1:'Ammunation', 2:'Fashion'}[item.type] || 'General'}</p>` : ''}</div>`;
            teleportBtn.classList.add('hidden');
            showRouteBtn.classList.add('hidden'); // Ensure route button is hidden for properties
            clearRoute(); // Clear any existing route when opening property modal
            coordModal.classList.remove('hidden');
            setTimeout(() => { coordModal.classList.remove('opacity-0'); coordModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95'); }, 10);
        }

        function hideCoordModal() { 
            // clearRoute(); // Ensure route is cleared when modal closes
            coordModal.classList.add('opacity-0'); 
            coordModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95'); 
            setTimeout(() => { coordModal.classList.add('hidden'); }, 300); 
        }
        
        async function handleTeleport() { 
            const playerName = modalTitle.textContent; 
            if (!playerName || !confirm(`Are you sure you want to teleport ${playerName}?`)) return; 
            try { 
                const response = await fetch(`${backendUrl}/api/player/${playerName}/teleport`, { method: 'POST' }); 
                if (response.ok) { 
                    alert('Teleport command sent!'); 
                    hideCoordModal(); 
                } else { 
                    throw new Error('Teleport failed'); 
                } 
            } catch (error) { 
                console.error('Teleport error:', error); 
                alert('Failed to teleport player.'); 
            } 
        }

        // --- ADDED FEATURE: Route Drawing and Interaction ---
        function clearRoute() {
            routeCtx.clearRect(0, 0, routeCanvas.width, routeCanvas.height);
            routeHitboxes.innerHTML = '';
        }

        function getZoneName(x, y) { for (const z of zones) { if (x>=z[1] && x<=z[4] && y>=z[2] && y<=z[5]) return z[0]; } return "Unknown Zone"; }
        function getFactionColor(factionId) { return factionColors[factionId] || factionColors.default; }
        function convertCoordinates(x, y) { const mapSize = 2048, gameMin = -3000, gameMax = 3000; const pX = (x-gameMin)/(gameMax-gameMin); const pY = (y-gameMin)/(gameMax-gameMin); return { left: pX * mapSize, top: (1-pY) * mapSize }; }
        
        let isDragging = false, startPos = { x: 0, y: 0 }, scale = 0.5, currentTranslate = { x: 0, y: 0 };
        function applyTransform(withTransition = false) { mapImage.style.transition = withTransition ? 'transform 0.5s ease-out' : 'none'; mapImage.style.transform = `translate(${currentTranslate.x}px, ${currentTranslate.y}px) scale(${scale})`; updateDotStyles(); }
        function initializeMapPosition(withTransition = false) { scale = mapContainer.clientWidth / 2048; currentTranslate.x = 0; currentTranslate.y = (mapContainer.clientHeight - 2048 * scale) / 2; applyTransform(withTransition); }
        mapContainer.addEventListener('mousedown', (e) => { isDragging = true; startPos.x = e.clientX - currentTranslate.x; startPos.y = e.clientY - currentTranslate.y; mapContainer.classList.add('grabbing'); });
        ['mouseup', 'mouseleave'].forEach(evt => mapContainer.addEventListener(evt, () => { isDragging = false; mapContainer.classList.remove('grabbing'); }));
        mapContainer.addEventListener('mousemove', (e) => { if (!isDragging) return; e.preventDefault(); currentTranslate.x = e.clientX - startPos.x; currentTranslate.y = e.clientY - startPos.y; applyTransform(); });
        mapContainer.addEventListener('wheel', (e) => { e.preventDefault(); const scaleAmount = 1.1; const mouseX = e.clientX - mapContainer.getBoundingClientRect().left; const mouseY = e.clientY - mapContainer.getBoundingClientRect().top; let newScale = e.deltaY < 0 ? scale * scaleAmount : scale / scaleAmount; newScale = Math.max(0.1, Math.min(20.0, newScale)); const scaleRatio = newScale / scale; currentTranslate.x = mouseX - (mouseX - currentTranslate.x) * scaleRatio; currentTranslate.y = mouseY - (mouseY - currentTranslate.y) * scaleRatio; scale = newScale; applyTransform(); });
        zoomInBtn.addEventListener('click', () => { scale = Math.min(20.0, scale * 1.2); applyTransform(true); });
        zoomOutBtn.addEventListener('click', () => { scale = Math.max(0.1, scale / 1.2); applyTransform(true); });

        toggleNamesBtn.addEventListener('change', () => document.querySelectorAll('.player-marker').forEach(m => m.classList.toggle('names-hidden', !toggleNamesBtn.checked)));
        onlineOnlyToggle.addEventListener('change', updatePlayerLocations);
        heatmapToggle.addEventListener('change', drawHeatmap);
        [toggleHousesBtn, toggleBusinessesBtn].forEach(el => el.addEventListener('change', drawProperties));
        
        closeCoordModalBtn.addEventListener('click', hideCoordModal);
        coordModal.addEventListener('click', (e) => { 
            if (e.target === coordModal) { // Only close if clicking the backdrop, not the modal content
                hideCoordModal(); 
            }
        });
        
        teleportBtn.addEventListener('click', handleTeleport);
        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
        propertySearchBtn.addEventListener('click', handlePropertySearch);
        propertySearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handlePropertySearch(); });
        mapImage.addEventListener('click', (e) => {
            const dot = e.target.closest('.player-dot');
            if (dot) { showCoordModal(dot.dataset.username, dot.dataset.posX, dot.dataset.posY); }
        });

        

        // --- ADDED FEATURE: Route Tooltip Listeners ---
        routeHitboxes.addEventListener('mouseover', e => {
            if (e.target.classList.contains('route-hitbox-segment')) {
                const rawTimestamp = e.target.dataset.timestamp;
                const date = new Date(rawTimestamp);
                date.setHours(date.getHours()); // Add 1 hour for timezone correction
                routeTooltip.innerHTML = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                routeTooltip.style.left = `${e.pageX}px`;
                routeTooltip.style.top = `${e.pageY}px`;
                routeTooltip.classList.remove('hidden');
            }
        });
        routeHitboxes.addEventListener('mouseout', () => routeTooltip.classList.add('hidden'));
        routeHitboxes.addEventListener('mousemove', e => {
            routeTooltip.style.left = `${e.pageX}px`;
            routeTooltip.style.top = `${e.pageY}px`;
        });

        function flyToLocation(x, y) { scale = 3.0; const { left, top } = convertCoordinates(x, y); currentTranslate.x = -left*scale + (mapContainer.clientWidth/2); currentTranslate.y = -top*scale + (mapContainer.clientHeight/2); applyTransform(true); }
        function highlightLocation(x, y) {
            document.getElementById('search-highlighter')?.remove();
            const { left, top } = convertCoordinates(x, y);
            const highlighter = document.createElement('div');
            highlighter.id = 'search-highlighter';
            highlighter.style.left = `${left - 16}px`;
            highlighter.style.top = `${top - 16}px`;
            mapImage.appendChild(highlighter);
            setTimeout(() => highlighter.remove(), 5000);
        }
        function handleSearch() { const searchTerm = searchInput.value.toLowerCase(); const foundPlayer = allPlayersData.find(p => p.username.toLowerCase() === searchTerm); document.querySelectorAll('.located').forEach(el => el.classList.remove('located')); if (foundPlayer) { flyToLocation(foundPlayer.pos_x, foundPlayer.pos_y); highlightLocation(foundPlayer.pos_x, foundPlayer.pos_y); } else { alert('Player not found!'); } }
        function handlePropertySearch() {
            const term = propertySearchInput.value.trim();
            if (!term) return;
            const isIdSearch = !isNaN(term);
            const searchId = isIdSearch ? parseInt(term) : null;
            const searchName = isIdSearch ? '' : term.toLowerCase();
            let found = null;
            found = allProperties.houses.find(h => (isIdSearch && h.id === searchId) || (!isIdSearch && h.owner && h.owner.toLowerCase().includes(searchName)));
            if (!found) { found = allProperties.businesses.find(b => (isIdSearch && b.id === searchId) || (!isIdSearch && b.owner && b.owner.toLowerCase().includes(searchName))); }
            if (found) { flyToLocation(found.pos_x, found.pos_y); highlightLocation(found.pos_x, found.pos_y); } else { alert('Property not found!'); }
        }

        initializeMapPosition();
        initialDataLoad();
        setInterval(periodicPlayerUpdate, 5000);
        window.addEventListener('resize', () => initializeMapPosition(true));
    });
    </script>
</body>
</html>