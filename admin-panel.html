<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Admin Panel - NV:RP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-heading: 'Audiowide', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --sidebar-width: 16rem;
        }
        body { font-family: var(--font-body); }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-heading); }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        @media (min-width: 768px) {
            .main-content { margin-left: var(--sidebar-width); }
        }
        .sidebar a.active, .sidebar a:hover { background-color: #00FFFF; color: #111827; }
        .sidebar a svg { width: 24px; height: 24px; }
        .btn { @apply px-3 py-1 rounded text-xs font-bold transition-colors; }
        .btn-red { @apply bg-red-600 hover:bg-red-500 text-white; }
        .btn-yellow { @apply bg-yellow-500 hover:bg-yellow-400 text-black; }
        .btn-blue { @apply bg-blue-500 hover:bg-blue-400 text-white; }
        .btn-green { @apply bg-green-500 hover:bg-green-400 text-white; }
        .btn-gray { @apply bg-gray-600 hover:bg-gray-500 text-white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-950/80 backdrop-blur-sm border-r border-gray-700 p-4 space-y-4 fixed inset-y-0 left-0 z-30 sidebar md:translate-x-0 -translate-x-full">
            <div class="flex items-center justify-between">
                 <h1 class="text-2xl font-bold text-cyan-400">NV:RP Admin</h1>
                 <button id="close-menu" class="md:hidden text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 py-2 px-4 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" id="player-management-link" class="flex items-center space-x-3 py-2 px-4 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span>Player Management</span>
                </a>
                <a href="#" id="server-control-link" class="flex items-center space-x-3 py-2 px-4 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                    <span>Server Control</span>
                </a>
                <a href="#" id="rcon-console-link" class="flex items-center space-x-3 py-2 px-4 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                    <span>RCON Console</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto main-content">
             <header class="bg-gray-800/50 backdrop-blur-sm p-4 flex items-center sticky top-0 z-20">
                <button id="menu-toggle-main" class="md:hidden text-gray-400 hover:text-white mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h2 id="page-title" class="text-2xl font-bold text-cyan-400"></h2>
            </header>
            <div class="p-4 md:p-8">
                <div id="player-management-section">
                    <div class="overflow-x-auto bg-gray-800/50 rounded-lg">
                        <table class="w-full text-left">
                            <thead class="bg-gray-900">
                                <tr>
                                    <th class="p-4">ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Ping</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="player-list-content" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="server-control-section" class="hidden">
                    <div id="server-status-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Global Announcement</h3>
                        <textarea id="announcement-text" class="w-full p-2 bg-gray-700 rounded border border-gray-600" placeholder="Enter your message..."></textarea>
                        <button id="send-announcement-btn" class="mt-2 bg-cyan-500 text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Send</button>
                    </div>
                    <div class="mt-6 bg-gray-800/50 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-2">Weather & Time</h3>
                        <div class="flex space-x-4">
                            <select id="weather-select" class="p-2 bg-gray-700 rounded border border-gray-600"></select>
                            <input type="number" id="time-input" min="0" max="23" class="p-2 bg-gray-700 rounded border border-gray-600" placeholder="Set Time (0-23)">
                            <button id="set-weather-time-btn" class="bg-cyan-500 text-black font-bold py-2 px-4 rounded hover:bg-cyan-400">Set</button>
                        </div>
                    </div>
                </div>

                <div id="rcon-console-section" class="hidden">
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <div id="console-output" class="h-96 overflow-y-auto bg-black p-2 rounded mb-4 font-mono text-sm"></div>
                        <div class="flex">
                            <input type="text" id="rcon-command-input" class="flex-1 p-2 bg-gray-700 rounded-l border border-gray-600" placeholder="Enter RCON command...">
                            <button id="send-rcon-command-btn" class="bg-cyan-500 text-black font-bold py-2 px-4 rounded-r hover:bg-cyan-400">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'admin.html';
                return;
            }
            document.getElementById('app-container').classList.remove('hidden');

            const backendUrl = "https://rcon-nvrp-backend.onrender.com";

            const sections = { playerManagement: document.getElementById('player-management-section'), serverControl: document.getElementById('server-control-section'), rconConsole: document.getElementById('rcon-console-section') };
            const links = { playerManagement: document.getElementById('player-management-link'), serverControl: document.getElementById('server-control-link'), rconConsole: document.getElementById('rcon-console-link') };
            const playerListContent = document.getElementById('player-list-content');
            const pageTitle = document.getElementById('page-title');
            const menuToggleMain = document.getElementById('menu-toggle-main');
            const closeMenuBtn = document.getElementById('close-menu');
            const sidebar = document.getElementById('sidebar');

            const navigate = (sectionName, title) => {
                Object.values(sections).forEach(s => s.classList.add('hidden'));
                sections[sectionName].classList.remove('hidden');
                pageTitle.textContent = title;
                Object.values(links).forEach(l => l.classList.remove('active'));
                if(links[sectionName]) links[sectionName].classList.add('active');
                if (window.innerWidth < 768) closeSidebar();
            };

            const openSidebar = () => sidebar.classList.remove('-translate-x-full');
            const closeSidebar = () => sidebar.classList.add('-translate-x-full');
            menuToggleMain.addEventListener('click', openSidebar);
            closeMenuBtn.addEventListener('click', closeSidebar);
            Object.keys(links).forEach(key => {
                links[key].addEventListener('click', (e) => {
                    e.preventDefault();
                    navigate(key, e.currentTarget.textContent.trim());
                });
            });

            const sendRconCommand = async (command) => {
                try {
                    const response = await fetch(`${backendUrl}/api/rcon/command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('RCON command failed:', error);
                    appendToConsole(`Error: ${error.message}`);
                    return { response: 'Error sending command.', players: [] };
                }
            };

            const fetchPlayers = async () => {
                const data = await sendRconCommand('players');
                playerListContent.innerHTML = data.players.map(player => `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-3">${player.id}</td>
                        <td class="p-3">${player.name}</td>
                        <td class="p-3">${player.ping}</td>
                        <td class="p-3 flex flex-wrap gap-2">
                            <button class="btn btn-red" onclick="kickPlayer('${player.id}', '${player.name}')">Kick</button>
                            <button class="btn btn-red" onclick="banPlayer('${player.id}', '${player.name}')">Ban</button>
                            <button class="btn btn-yellow" onclick="mutePlayer('${player.id}', '${player.name}')">Mute</button>
                            <button class="btn btn-blue" onclick="sendMessage('${player.id}', '${player.name}')">Message</button>
                            <button class="btn btn-green" onclick="giveCash('${player.id}', '${player.name}')">Give Cash</button>
                            <button class="btn btn-gray" onclick="jailPlayer('${player.id}', '${player.name}')">Jail</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="p-4 text-center">No players online.</td></tr>';
            };

            window.kickPlayer = (id, name) => {
                const reason = prompt(`Reason for kicking ${name}:`, 'Disruptive behavior');
                if (reason) sendRconCommand(`kick ${id} ${reason}`).then(fetchPlayers);
            };
            window.banPlayer = (id, name) => {
                const reason = prompt(`Reason for banning ${name}:`, 'Rule violations');
                if (reason) sendRconCommand(`ban ${id} ${reason}`).then(fetchPlayers);
            };
            window.mutePlayer = (id, name) => {
                if (confirm(`Are you sure you want to mute ${name}?`)) sendRconCommand(`mute ${id}`).then(fetchPlayers);
            };
            window.sendMessage = (id, name) => {
                const message = prompt(`Message to send to ${name}:`);
                if (message) sendRconCommand(`pm ${id} ${message}`);
            };
            window.giveCash = (id, name) => {
                const amount = prompt(`Amount to give to ${name}:`, '10000');
                if (amount && !isNaN(amount)) sendRconCommand(`givecash ${id} ${amount}`);
            };
            window.jailPlayer = (id, name) => {
                const time = prompt(`Jail time in seconds for ${name}:`, '60');
                if (time && !isNaN(time)) sendRconCommand(`jail ${id} ${time}`);
            };

            const serverStatusCards = document.getElementById('server-status-cards');
            const announcementText = document.getElementById('announcement-text');
            const sendAnnouncementBtn = document.getElementById('send-announcement-btn');
            const weatherSelect = document.getElementById('weather-select');
            const timeInput = document.getElementById('time-input');
            const setWeatherTimeBtn = document.getElementById('set-weather-time-btn');

            const fetchServerStatus = async () => {
                const [hostnameData, gamemodeData, playersData] = await Promise.all([
                    sendRconCommand('hostname'), sendRconCommand('gamemodetext'), sendRconCommand('players')
                ]);
                serverStatusCards.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg"><h3 class="font-semibold text-gray-400">Hostname</h3><p class="text-xl font-bold">${hostnameData.response}</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg"><h3 class="font-semibold text-gray-400">Gamemode</h3><p class="text-xl font-bold">${gamemodeData.response}</p></div>
                    <div class="bg-gray-800 p-4 rounded-lg"><h3 class="font-semibold text-gray-400">Players</h3><p class="text-xl font-bold">${playersData.players.length} / 100</p></div>
                `;
            };
            sendAnnouncementBtn.addEventListener('click', () => {
                const text = announcementText.value;
                if(text) {
                    sendRconCommand(`say [ADMIN] ${text}`);
                    announcementText.value = '';
                }
            });
            const weatherOptions = { "Sunny": 1, "Cloudy": 2, "Rainy": 3, "Foggy": 4, "Sandstorm": 9 };
            weatherSelect.innerHTML = Object.keys(weatherOptions).map(w => `<option value="${weatherOptions[w]}">${w}</option>`).join('');
            setWeatherTimeBtn.addEventListener('click', () => {
                const weather = weatherSelect.value;
                const time = timeInput.value;
                if(weather) sendRconCommand(`weather ${weather}`);
                if(time) sendRconCommand(`worldtime ${time}`);
            });

            const consoleOutput = document.getElementById('console-output');
            const rconCommandInput = document.getElementById('rcon-command-input');
            const sendRconCommandBtn = document.getElementById('send-rcon-command-btn');

            const appendToConsole = (text) => {
                consoleOutput.innerHTML += `<div>${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };
            
            const handleRconSubmit = async () => {
                const command = rconCommandInput.value;
                if (!command) return;
                appendToConsole(`> ${command}`);
                const data = await sendRconCommand(command);
                appendToConsole(data.response.split('\n').join('<br>'));
                rconCommandInput.value = '';
            };

            sendRconCommandBtn.addEventListener('click', handleRconSubmit);
            rconCommandInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleRconSubmit(); });

            // Initial Load
            navigate('playerManagement', 'Player Management');
            fetchPlayers();
            fetchServerStatus();
            setInterval(fetchPlayers, 10000); // Refresh player list every 10 seconds
            setInterval(fetchServerStatus, 60000); // Refresh server status every minute
        });
    </script>
</body>
</html>
